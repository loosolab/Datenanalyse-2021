Work Package 3
=======================================

Introduction 
------------

WP3 Contains a script to separate one .bam file of a tissue into seperate files using a cluster assignment table as instructions. It also contains a customised .yaml file for the TOBIAS Snakemake Pipeline, that was used to further process the data from these cluster .bam files.

Installation
------------
Simply clone this repository. Before running the clustering script you will need to also install [pysam](https://pypi.org/project/pysam/) in your python environment. Also for processing the data the use of [SAM-Tools](https://www.htslib.org/download/) is recommended.

You also need to download the [TOBIAS snakemake repository](https://github.molgen.mpg.de/loosolab/TOBIAS_snakemake) and set up the anaconda environment with the yml file provided in it like this:

```bash
conda env create -f environments/snakemake.yaml
```

Workflow description
--------------------

Converting the .sam file from WP2 to a .bam file and sorting it with samtools. You can use the utility script "preprocessingSam.sh" like this:
```bash
./preprocessingSam.sh sample.sam
```

Alternatively you can do it yourself using these commands:
```bash
samtools view -S -b sample.sam > sample.bam
samtools sort sample.bam -o sample_sorted.bam
samtools index sample_sorted.bam
```

Running the clustering script:
```bash
./cluster.py -b ./sample_sorted.bam -t ./cluster_assignment_table.tsv -o ./clusterBams/
```

The clustering script produces a seperate .bam file for each cluster in the assignment table. It also generates a "snakemakeIn.txt" text file containing the paths and names of the cluster .bam files.

You can use the config file provided in this repository (config.yaml).
Paste the text from snakemakeIn.txt into the appropriate section inside the config.yaml and make sure all paths in it lead to the correct files.
Some flags are disabled inside it for this project if you need them you can set them to True instead.

Running the TOBIAS snakemake pipeline:

If it is your first run you might need to update the snakemake version inside your TOBIAS snakemake environment:
```bash
conda activate tobias_snakemake_env
pip install --upgrade snakemake
```
Then you can run the snakemake pipeline:
```bash
conda activate tobias_snakemake_env
snakemake --configfile config.yaml --use-conda --cores [NUMBER_OF_CORES] --conda-prefix /tmp --keep-going
```
After running the snakemake pipeline, further analysis is done with the bindetect_results.txt file for each cluster as well as the bindetect_distances file. These are found in /output/TFBS/. The latter is used to cluster transcription factors into families based on binding motif similarity. This is done via the "TFClustering.py" script. 
```bash
python TFClustering.py bindetect_distances.txt
```
The file "TF_families.tsv" generated by this operation can be used to lower the resolution of the results of the analysis into a more general overview. This is useful because TOBIAS BINDetect is unable to distinguish which transcription factor exactly occupied a position on the DNA based on the provided data, as the scores can only be deduced by the binding motif present on the DNA and thus multiple transcription factors with very similar motifs will also have a similar score. Grouping these transcription factors (which often times have similar functions as well) usually allows for a better overview over the transcription factor spectrum that defines the analysed cluster. 

The binding scores are extracted and brought into a format that allows futher processing via the script "CompareClusterScore.py". 
```bash
python CompareClusterScore.py bindetect_results.txt -f [TF family file]
```
It takes the binding scores for each cluster of the tissue and each transcription factor and writes them down in CLARION file format, which is necessary for heatmap visualization using WIlsON. A docker container containing WIlsON as well as instructions how to use it can be found [here](https://hub.docker.com/r/loosolab/wilson/).
The heatmap gives a visual overview over the data, depicting a scoring profile for each cluster, and shows which transcription factors scored remarkably in some clusters in comparison to the others.

To gain a better understanding of the transcriptions factors that were remarkably over-represented in certain clusters, the script "DefiningTF.py" extracts the top transcription factors by z score and writes them done in a .tsv file. 
```bash
python DefiningTF.py [CLARION file]
```

This file (as well as those of other tissues at the same time, if that is desired) can be visualized to find out whether transcription factors are defining for multiple cluster or are unique to a certain cell type. This can be done using the script "ProfileSimilarity.py", which generates a bubble plot. The color of the bubble shows in how many clusters this transcription factor made the list of defining transcriptions factors. The bubble size shows how many members are in an examined family (this is done to make it perceptible if a transcription factor family perhaps only entered the defining transcription factors of multiple clusters because it is quite large and different transcription factors in this family might be the reason for this classification). 
```bash
python ProfileSimilarity.py [DefiningTF file] -f [TF family file]
```
The commands shown here are used run the scripts in their default setting for our analysis. Different options and flags can be found in the [wiki](https://github.com/loosolab/Datenanalyse-2021/wiki/WP3#wp3-scripts)

Known issues and limitations
----------------------------
pysam does only work correctly under Linux operating systems, as it is a requirement for the clustering script it will probably not work on windows.
