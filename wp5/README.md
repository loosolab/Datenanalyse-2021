# Work Package 5 - Motif Discovery

## Introduction

The aim of WP5 is to ***discover new motifs*** based on the data generated by WP3. The work package provides a pipeline to prepare and automatically 
run the motif discovery pipeline developed by Hendrik Schultheis. Furthermore, the work package includes some scripts to analyse the newly discovered 
motifs and to give first insights into their possible biological meaning.

## Setup and Installation
To use this work package it is important that you have two further tools installed:
* [TOBIAS](https://github.com/loosolab/TOBIAS)
* [motif discovery pipeline](https://github.com/loosolab/motif-discovery-pipeline)

Please follow the installation instructions of these projects and make sure that you have installed the corresponding conda environments. It is necessary that the TOBIAS environment is called "TOBIAS_ENV". 
You also need an environment for snakemake, which should also be called "snakemake".

Additionally, it is necessary to create the conda environment from the provided YAML file. This can be done with the following command.

```
conda env create -f plotting_env.yml
```

To use the scripts of this work package, this repository must be cloned. The scripts are executed directly.

## Usage
This work package consists of several scripts ( located in the *scripts* directory) that can be executed individually or as a cascading pipeline. More detailed information can be found in the [WP5 Wiki](https://github.com/loosolab/Datenanalyse-2021/wiki/WP5).

Before you start the pipeline (or the individual scripts), it is **important** to adjust the configuration file with the global variables. 
To do this, please open *global_vars.cnf* and adjust the 6 specified variables.

The variables have the following meaning:

* PROJECT_DIR : Path to the folder to which all outputs are to be written
* TBSDIR : Path to WP3 output (should contain all tissue folders)
* MDP_PIPELINE : Path to your installation of the motif discovery pipeline
* GENOME : Genome fasta of the analysed organism. It should be the same file that was used in the preceeding work packages.
* GTF : GTF of the analysed organism. It should be the same file that was used in the preceeding work packages.
* DATA_PREP_DIR : Directory where the output of the data preparation (WP2) lies. Needed to assign cell type names.
* ANN_CHECKER=yes : If 'yes', then the motif discovery is carried out with the annotation step, otherwise the annotation is skipped.

After adjusting the configuration file containing the global variables, you can start the pipeline with the following command:

```
./run_all.sh
```

Please make sure that you execute this command in the directory where the script *run_all.sh* is located.

If you want to activate the step "check logs" (see [below](#3-check-logs)) after the motif search, you can do this by adding the flag `--check-logs` or `-c`. In this case, the pipeline would be started as follows:

```
./run_all.sh --check-logs
```

> **Caution**: If you are working via an SSH connection, you should start this script in a screen, as it may require some time to run.

The single steps of the pipeline consist of the following scripts:
1. [preparations.sh](#1-preparations)    
2. [run_pipeline.sh](#2-run-pipeline)
3. [check_logs.sh](#3-check-logs) (optional)
4. [renameAllMotifs.sh](#4-rename-motifs)
5. [cluster_all.sh](#5-cluster-all)
6. [Eval_Motif_similarity.py](#6-evaluate-motif-similarity)
7. [generate_gene_sets.sh](#7-generate-gene-sets)
8. [generate_gene_sets_TFs.sh](#8-generate-gene-sets-for-transcription-factors)
9. [compare_gene_sets.py](#9-compare-the-gene-sets)
10. [analyze_GO_and_pathway.py](#10-analyze-the-gene-sets)

Steps 1-4 include the actual motif-finding pipeline runs, as well as the necessary preparation and post-processing.
Steps 5 and 6 are used to analyse similarities between the motifs found in different runs of the pipeline (i.e. different tissue and cell types).
Steps 7-10 are used to analyse the motifs found with the aim of hypothesising the important functions of the motifs.
Since this pipeline is designed for ATAC-Seq data, the motif discovery pipeline is run for each cell type of each given tissue.

### 1. Preparations
The script *preparations.sh* is called as follows:

```
./preparations.sh
```

This script creates configuration files from the WP3 output. A configuration file is created for each WP3 run. These configuration files are used to 
start the motif discovery pipeline for the different conditions (i.e. tissue and cell types) of the different runs.
Along with this, this script creates all the necessary directories for further analysis, that are expected by the following scripts.

### 2. Run pipeline
The script *run_pipeline.sh* is called as follows:

```
./run_pipeline.sh
```

The script starts the motif discovery pipeline for all configuration files found in the *configs* directory within the project directory specified in the configuration file. 

> **Caution**: If you are working via an ssh connection, make sure you start this script in a screen as it may require some time to complete.

### 3. Check logs
This script is an optional script to get a quick overview if all pipeline runs worked as expected.
The script *check_logs.sh* is called as follows:

```
./check_logs.sh
```

The script checks the *log files* of the analysed tissues and their corresponding cell types to see if the pipeline runs were successful (including the annotation runs). 

### 4. Rename motifs
This script is necessary because the motif discovery pipeline gives the motifs pseudo-names (for example *motif_0*). 
Since the same pseudo-names can occur in more than one run, it is important for further analysis to rename the motifs unambiguously.
For the MEME files generated by the motif-finding pipeline, this is done automatically by this script.

The script can be called as follows:
```
./renameAllMotifs.sh
```
### 5. Cluster all
To determine whether one of the motifs found (a very similar motif, respectively) occurs in different tissues or cell types, the scripts *cluster_all.sh* and 
*eval_Motif_similarity.py* are provided.  
The idea is to cluster all motifs found with a reasonably low threshold (=0.3) using TOBIAS. All clusters found are then classified as the same motif.
A consensus sequence is calculated for each cluster, which can be used for further analysis. However, a manual verification is recommended before using the consensus sequence.

To perform the clustering, the script is called as follows:

```
./cluster_all.sh <Clustering_Name> 
```

The parameter "<Clustering_Name>" is the prefix that the output folder of the clustering will carry. It should therefore be indicative of the output. In the pipeline *run_all.sh*, the specified prefix is "overall".

### 6. Evaluate motif similarity
With this step, the results of the clustering can be evaluated by plotting them. 
To do this, you can call the script as follows:
```
./eval_Motif_similarity.py --runs_dir <PATH/TO/RUNS> --motifs <motif_comparison_clusters.yml> --out <FILENAME_prefix>
```

For more information on the parameters, please refer to the wiki or the manual of the script (`--help` flag). 
The script produces various diagrams to visualise the occurrence of similar motifs in different tissues and cell types. 
It also saves the names of the found motifs together with their cluster, cell type and tissue in a tsv table.

If you want to run this script on its own, please activate the plotting environment beforehand:
```
conda activate plotting
```

### 7. Generate gene sets
In order to evaluate the annotation of the motifs, it is first necessary to collect the information about which genes belong to the motif.
The script provided here collects this information from the **allhits.txt* of the different motifs. From this, txt files are created for each individual motif on the one hand and txt files for each cell type on the other hand. The files of the cell types contain all associated motifs (not just one motif, as is the case in the txt files of the individual motifs).

The script *generate_gene_sets.sh* is called as follows:

```
./generate_gene_sets.sh
```

> **Caution**: If you are working via an ssh connection, make sure you start this script in a screen as it may require some time to complete.

### 8. Generate gene sets for transcription factors
In order to evaluate the annotation of the motifs, it is also necessary to collect information about which genes belong to the known TFs.
The script provided here collects this information per tissue from the **overview.txt* of the different TFs (from the WP3 output data) and creates txt files for all tissues (all associated TFs are stored in this file).

The script *generate_gene_sets_TFs.sh* is called as follows:

```
./generate_gene_sets_TFs.sh
```

> **Caution**: If you are working via an ssh connection, make sure you start this script in a screen as it may require some time to complete.

### 9. Compare the gene sets
In order to compare the gene sets of the motifs and TFs, this script performs some analyses.

The script *compare_gene_sets.py* is called as follows:

```
./compare_gene_sets.py
```

The script calculates which known TFs are correlated the most with the new motifs (= new TFs). 
The new motifs are also compared across tissues and cell types. The aim is to identify identical motifs on the one hand and correlated motifs on the other. In addition, the aim is to identify motif-specific genes.

### 10. Analyze the gene sets

To use the annotation analysis, it is necessary to use two online tools for [GO analysis](http://www.pantherdb.org) and [pathway analysis](https://reactome.org) beforehand. 

For Gene Ontology (GO) analysis, you need to insert the gene sets to be analysed from the files (motif gene sets are stored in *annotation/gene_sets_motifs*). Please select *Statistical overrepresentation test* and then *GO biologialprocess complete* in step 3 *Select analysis*. From the analysis results, you need to export the "Table". The output file will automatically be named *analysis.txt*. Please rename the file (should contain the motif name), e.g. *motifName_analysis.txt* and save the files in the folder *annotation/GO_analysis*.

For the pathway analysis you have to select the [Analysis Tools](https://reactome.org/PathwayBrowser/#TOOL=AT). There you have to enter the gene sets from the files (motif gene sets are stored in *annotation/gene_sets_motifs*) you want to analyse. From the analysis results you have to export the "Pathway analysis results" and the "Not found identifiers". The output files are automatically named *result.csv* ("Pathway analysis results") and *not_found.csv* ("Not found identifiers"). Please rename the files (add the motif name) like *motifName_results.csv* or *motifName_not_found.csv* and save the files in the folder *annotation/GO_analysis*.

To analyse the gene sets of the motifs, the script *analyze_GO_and_pathway.py* which is provided here performs a GO and pathway analysis based on the results of the two databases described above. The script extracts the most significant GO process from the GO output and the most significant pathway from the pathway output and generates a ranking table in csv format. The analysis criterion is the p-value.

The script *analyze_GO_and_pathway.py* is called as follows:

```
./analyze_GO_and_pathway.py
```

## Example
TODO
